# Kieslijsten converter

Create the appropriate data structures based on provided data

## Configuring this converter

1. Place the required data in `data/db/toLoad`. Or start from a database containing these items.

- person uri's with a link to their identifier (rrn)
- previously generated administrative bodies for the new legislature
- administrative units, including links to administrative bodies
- mandates, linked to their respective administrative bodies

> [!NOTE]
> If you are using a dump of a pre-existing database instead, make sure that there are no pre-existing instances of RechstreekseVerkiezingen in your database for the target date.

2. Place the required source data in `data/input/<year_of_election>`

- `lijsten.csv` a csv with candidate lists per township (required headers: `kieskring`, `lijstnr`, `lijst`, `datum` )
- `kandidaten.csv` a csv with candidates per list per township (required headers: `kieskring`, `lijstnr`, `verkregen zetels`, `volgnr`, `RRvoornaam `, `RRachternaam`, `RR`, `verkozen`, `opvolger`, `naamstemmen`, `geslacht`, `geboortedatum`)

The kandidaten.csv file contains sensitive data. Do not commit this to this repository. An example kandidaten file with fake information is added to this repo instead. It contains fake results for the Aalter and Aarschot administrative bodies.

3. Add any necessary transformation queries in `data/transforms/<year_of_election>`.
   These queries will run after the input has been loaded, queries should have a `.rq` extension

4. Update the converter with the correct year of election
   At the bottom of `convert-to-ttl.rb` paths are defined. Update **input_path** and **transform_path** to point to the correct election folder.

5. Configure the env variables:

- `ENDPOINT`: SPARQL endpoint to connect to ('http://database:8890/sparql')
- `KANDIDATENLIJST_TYPE_IRI`: iri of the type of the candidates list ('http://data.vlaanderen.be/id/concept/KandidatenlijstLijsttype/95de36e5-8c7a-4308-af7b-75afbd943dd2')
- `BESTUURSORGAAN_TYPE_IRI`: iri of the type of administrative body the 'http://data.vlaanderen.be/id/concept/BestuursorgaanClassificatieCode/5ab0e9b8a3b2ca7c5e000005' # gemeenteraad
- `ORGAAN_START_DATUM`: start date of the elected administrative body
- `LOG_LEVEL`: "info" or "debug"
- `INPUT_DATE_FORMAT`: date format used in the CSV's ("%d/%m/%Y")

## Running this converter

```
  docker-compose up
```

The end result will be available in ./data/output/

- sensitive data will be written to ./data/output/[date]-[type]-sensitive.ttl
- other data will be written to ./data/output/[date]-[type].ttl

The data being produced is:

- **personen.ttl**: this contains the uri for every person in the kandidaten.csv, with their birth data, gender, first and last name. It also contains their election result (mandaat:Verkiezingsresultaat) with the number of votes, link to the list, mandaat:rangorde and mandaat:gevolg. If a person with a matching RRN is found in the loaded data, the uri for that person is reused.
- **personen-sensitive.ttl**: this contains the identificator for the persoon, holding the RRN
- **rechstreekse-verkiezingen-en-kandidatenlijsten.ttl**: the newly minted uris for instances of mandaat:RechstreekseVerkiezing and mandaat:Kandidatenlijst with all their properties.

A line is commented in the convert-to-ttl script where the function update_kieslijsten is called. It allows the lijstnummers for the kieslijsten to be updated given that the information generated in the previous step is already in the database (so it keeps the old uris but recomputes the kieslijst numbers based on the lijsten.csv).

## Import the generated triples in your application

After you ran the converter, the data containing the new Bestuursorgaan and Mandaat entities have been inserted in the database by the transformer. If you want these triples to be imported into your application you can use the sparql file **constructed_data/<year_of_election>** to query these triples.

1. Run the construct query on the database ('http://database:8890/sparql')
2. Copy the outputed data
3. Go to your application where you want to import the triples
4. We will create two files in the **/config/migrations/** folder (if it is fake data we suggest you put it in a `/local` folder under `/migrations`)
5. The first file is the `.ttl` file where we paste the output of our construct query
6. The second file (`.graph`) will say in what graph we want to insert this data
7. Make sure the only difference between those files are the extension

You will get the following structure:

```bash
- config
  - migrations
    - <dateTime>-election-import.ttl
    - <dateTime>-election-import.graph
```

## Extra scripts

#### Getting the constructed data

The folder `constructed-data` contains construct queries to fetch information that was generated by this script. At the time of this writing, it only fetches the bestuursorganen in tijd, with link to their bestuursorgaan and their mandates.

#### create-fusiegemeenten.rb

One off script to add some extra administrative units and organs for the 2019 elections

#### import-burgemeester.rb

This is a script used in the 2019 elections. It generates burgemeesters based on the provided csv file. In the 2024 elections, this process was completely overhauled, LMB introduced an integration with the Kaliope system and this script is now outdated.

This script needs a `burgemeesters2019.csv` in `burgmeesters/data/input` and a (recent) backup to restore in `burgemeesters/data/db/backups`. The correct prefix needs to be set in docker-compose.yml. Output will be written to `burgmeesters/data/output`, it's a ttl that has the new `mandatarissen`. Errors are logged to stdout.

```
cd burgmeesters
docker-compose up
```

## Warnings regarding person identifiers

This script attempts to reuse person and person identifier URIs. It does this by matching persons on RRN based on the information that is in its database. It is therefore important that this information is up to date and complete.

HOWEVER, there are still a lot of cases where this can go wrong:

- a person was created multiple times in different organs without them knowing about one another (same RRN but because it is in different organs, the users don't know)
- incomplete or incorrect information from the election results or from the data included in this script's database (e.g. the LMB dataset)

Person's are matched based on their RRN. If a person with that RRN already exists in the data, that information is taken as canonical. Missing fields like first name and lastname, etc are updated if they were not in the database yet but ARE in the provided csv file.

Extra care should be taken that the RRN from the csv are properly mapped to the existing rrn from the data.

## Issues regarding names from the kieslijsten data

It was apparently impossible to split the first names from the rijksregister information, so to find the correct first name, the name on the "stembiljet" is taken in `find_first_voornaam` this resulted in important issues like `boer teun` being a first name for a person. If we ever do this again, highly suggest reiterating this principle with the providers of the csv file to take the official first name from the rijksregister.

### data/transforms/new-bestuursorganen-and-mandates

These transforms are sparql queries that generate new bestuursorganen and mandates for the 2018 and 2024 election based on the organen that were previously available (but ignoring some that no longer exist).

### data/transforms/2018/fix-already-existing-persons

This is a set of construct queries that attempts to fix duplicates/person names based on the already existing persons. Note: later, many problems were still detected with these existing persons, so these fixes definitely missed a lot of cases (e.g. see migrations in LMB).

A similar attempt was done for the 2024 elections, see `/data/2025-duplicate-person-resolution` but with the same warnings.
